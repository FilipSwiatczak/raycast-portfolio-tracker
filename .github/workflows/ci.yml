# ──────────────────────────────────────────────────────────────────────────────
# CI Pipeline — Portfolio Tracker (Raycast Extension)
#
# Triggers:
#   • Pull Requests → main : Gate merges with required status checks
#   • Push → main          : Validate post-merge integrity
#
# Separate treatment:
#   • PRs:   Cancel in-progress runs when new commits are pushed (save resources)
#   • Main:  Never cancel — every merge must be fully verified
#
# Jobs run in parallel for clear, per-concern GitHub status checks:
#   ✓ Lint & Format   — ESLint + Prettier (portable, no Raycast CLI dependency)
#   ✓ Type Check       — tsc --noEmit
#   ✓ Unit Tests       — Jest (167 tests, ~0.3s)
#
# Note: We use plain eslint/prettier instead of `ray lint` because the Raycast
# CLI requires macOS. Running on ubuntu-latest is faster and cheaper.
# ──────────────────────────────────────────────────────────────────────────────

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# ---------------------------------------------------------------------------
# Shared environment
# ---------------------------------------------------------------------------
env:
  NODE_VERSION: "22"

jobs:
  # ─── Lint & Format ────────────────────────────────────────────────────────
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: ESLint
        run: npm run lint:eslint

      - name: Prettier
        run: npm run lint:prettier

  # ─── Type Check ───────────────────────────────────────────────────────────
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript (tsc --noEmit)
        run: npm run typecheck

  # ─── Unit Tests ───────────────────────────────────────────────────────────
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Jest
        run: npm test

  # ─── Post-merge gate (main only) ─────────────────────────────────────────
  # Runs after all checks pass on main to confirm the merge is healthy.
  # This is a no-op sentinel job that downstream branch protection or
  # notifications can depend on.
  main-ok:
    name: Main OK
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [lint, typecheck, test]
    runs-on: ubuntu-latest
    steps:
      - name: All checks passed
        run: echo "✅ All quality checks passed on main"
